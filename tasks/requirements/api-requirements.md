# Технические требования к API

## Общие принципы

### 1. REST API
- Использовать REST принципы для всех эндпоинтов
- Правильные HTTP методы (GET, POST, PUT, DELETE)
- Корректные HTTP статус коды
- Семантические URL пути

### 2. Версионирование
- Все API должны быть версионированы: `/api/v1/`
- При изменении API создавать новую версию
- Поддерживать обратную совместимость

### 3. Документация
- Swagger/OpenAPI документация для всех эндпоинтов
- Примеры запросов и ответов
- Описание всех полей и ошибок
- Автоматическая генерация документации

## Стандарты ответов

### Успешный ответ
```json
{
  "data": {
    // данные ответа
  },
  "meta": {
    "timestamp": "2024-01-01T12:00:00Z",
    "version": "1.0"
  }
}
```

### Ошибка
```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Описание ошибки",
    "details": {
      "field": "описание проблемы с полем"
    }
  },
  "meta": {
    "timestamp": "2024-01-01T12:00:00Z",
    "version": "1.0"
  }
}
```

### Пагинация
```json
{
  "data": [
    // элементы
  ],
  "pagination": {
    "page": 0,
    "size": 20,
    "totalElements": 100,
    "totalPages": 5
  },
  "meta": {
    "timestamp": "2024-01-01T12:00:00Z",
    "version": "1.0"
  }
}
```

## HTTP статус коды

### Успешные ответы
- `200 OK` - Успешный GET запрос
- `201 Created` - Успешный POST запрос
- `204 No Content` - Успешный DELETE запрос

### Ошибки клиента
- `400 Bad Request` - Неверный запрос
- `401 Unauthorized` - Не авторизован
- `403 Forbidden` - Нет прав доступа
- `404 Not Found` - Ресурс не найден
- `409 Conflict` - Конфликт данных
- `422 Unprocessable Entity` - Ошибка валидации

### Ошибки сервера
- `500 Internal Server Error` - Внутренняя ошибка сервера
- `502 Bad Gateway` - Ошибка внешнего сервиса
- `503 Service Unavailable` - Сервис недоступен

## Валидация

### Входные данные
- Валидация всех входных параметров
- Проверка типов данных
- Проверка бизнес-правил
- Понятные сообщения об ошибках

### Пример валидации
```java
@Valid
public record AgreementCreateRequest(
    @NotNull(message = "Тип перевозки обязателен")
    TransportationType transportationType,
    
    @NotBlank(message = "Наименование груза обязательно")
    @Size(max = 255, message = "Наименование груза не более 255 символов")
    String cargoName,
    
    @Min(value = 0, message = "Отсрочка платежа не может быть отрицательной")
    @Max(value = 365, message = "Отсрочка платежа не более 365 дней")
    Integer paymentDelay
) {}
```

## Безопасность

### Аутентификация
- JWT токены для всех защищенных эндпоинтов
- Проверка токенов на каждом запросе
- Автоматическое обновление токенов

### Авторизация
- Проверка ролей пользователя
- Проверка прав доступа к ресурсам
- Аудит всех операций

### Валидация данных
- Санитизация входных данных
- Защита от SQL инъекций
- Защита от XSS атак

## Производительность

### Требования к времени ответа
- Простые GET запросы: < 100ms
- Сложные GET запросы: < 200ms
- POST/PUT запросы: < 500ms
- DELETE запросы: < 200ms

### Оптимизация
- Использовать индексы в БД
- Избегать N+1 запросов
- Использовать кэширование
- Пагинация для больших списков

### Мониторинг
- Логирование времени ответа
- Мониторинг ошибок
- Алерты при превышении лимитов

## Логирование

### Структура логов
```json
{
  "timestamp": "2024-01-01T12:00:00Z",
  "level": "INFO",
  "service": "coube-backend",
  "traceId": "abc123",
  "userId": "user123",
  "method": "GET",
  "path": "/api/v1/agreements",
  "duration": 150,
  "status": 200,
  "message": "Agreement list retrieved successfully"
}
```

### Уровни логирования
- `ERROR` - Критические ошибки
- `WARN` - Предупреждения
- `INFO` - Информационные сообщения
- `DEBUG` - Отладочная информация

## Тестирование

### Unit тесты
- Покрытие кода > 80%
- Тестирование всех сервисов
- Тестирование валидации
- Mock внешних зависимостей

### Integration тесты
- Тестирование всех эндпоинтов
- Тестирование с реальной БД
- Тестирование авторизации
- Тестирование производительности

### Тестовые данные
- Фикстуры для всех сущностей
- Автоматическая очистка данных
- Изолированные тесты

## Документация API

### Swagger/OpenAPI
```yaml
openapi: 3.0.0
info:
  title: Coube API
  version: 1.0.0
  description: API для системы логистики Coube

paths:
  /api/v1/agreements:
    get:
      summary: Получить список контрактов
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 0
        - name: size
          in: query
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: Успешный ответ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AgreementListResponse'
```

### Примеры запросов
- Примеры для всех эндпоинтов
- Примеры ошибок
- Примеры с разными параметрами

## Версионирование

### Правила версионирования
- Мажорная версия при несовместимых изменениях
- Минорная версия при новых функциях
- Патч версия при исправлениях

### Миграция версий
- Поддержка старых версий 6 месяцев
- Уведомления о deprecation
- Автоматическая миграция данных

## Мониторинг и алерты

### Метрики
- Количество запросов в секунду
- Время ответа
- Количество ошибок
- Использование ресурсов

### Алерты
- Высокое время ответа (> 500ms)
- Высокий процент ошибок (> 5%)
- Недоступность сервиса
- Высокое использование ресурсов

## Развертывание

### CI/CD
- Автоматические тесты
- Автоматическое развертывание
- Rollback при ошибках
- Blue-green deployment

### Конфигурация
- Environment-specific конфигурация
- Feature flags
- A/B тестирование
- Canary releases 